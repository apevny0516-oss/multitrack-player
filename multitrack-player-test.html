<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Multitrack Player</title>
<style>
body { font-family: sans-serif; background: #f5f5f5; padding: 1rem; }
.track { background: white; padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
button { cursor: pointer; border: 1px solid #ccc; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 1rem; }
button.active { background-color: #007bff; color: white; border-color: #007bff; }
.progress-container { margin-top: 1rem; position: relative; }
.time { font-size: 0.8rem; display: flex; justify-content: space-between; color: #555; }
.loop-highlight { position: absolute; top: 50%; height: 6px; background: rgba(0,123,255,0.3); border-radius: 3px; transform: translateY(-50%); pointer-events: none; }
#bookmarksPanel h3 { margin-bottom: 0.75rem; }
#bookmarksPanel button {
  font-size: 1.2rem;
  font-weight: bold;
  margin-bottom: 0.6rem;
  padding: 0.5rem 0.75rem;
  display: block;
  width: 100%;
  text-align: left;
}
.controls { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.volume-line {
  flex-basis: 100%;
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 0.5rem;
}
@media (max-width: 600px) {
  .volume-line { flex-direction: column; align-items: flex-start; }
}
#loadingOverlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(255,255,255,0.9);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem; font-weight: bold; color: #333;
  z-index: 999; flex-direction: column;
}
</style>
</head>
<body>
<h2 id="pageTitle">Multitrack Player</h2>
<div id="loadingOverlay"><div id="loadingText">Now Loading...</div></div>

<div class="controls">
  <button id="play">▶️</button>
  <button id="pause">⏸️</button>
  <button id="stop">⏹️</button>
  <button id="loop">Loop Start</button>
  <button id="leadIn">Lead-In: Off</button>
  <div class="volume-line">
    <label for="masterVol">Master Volume</label>
    <input id="masterVol" type="range" min="0" max="1" step="0.01" value="1">
  </div>
</div>

<div id="progressContainer" class="progress-container"></div>
<div id="tracks"></div>
<div id="bookmarksPanel" style="margin-top:1rem;"></div>

<script>
let leadInEnabled = false;
document.getElementById('leadIn').addEventListener('click', (e)=>{
  leadInEnabled = !leadInEnabled;
  e.target.textContent = `Lead-In: ${leadInEnabled ? 'On' : 'Off'}`;
  e.target.classList.toggle('active', leadInEnabled);
});

const params = new URLSearchParams(window.location.search);
const stems = [];
let markersFile = null;

// dynamic title
const titleParam = params.get("title");
if (titleParam) {
  document.title = decodeURIComponent(titleParam);
  document.getElementById("pageTitle").textContent = decodeURIComponent(titleParam);
}

// build stems list with proxy logic
for (const [key, value] of params.entries()) {
  const k = key.toLowerCase();
  if (k === 'title') continue;

  let finalUrl = value;
  if (finalUrl.includes("googleapis.com/drive")) {
    const proxy = "https://cors.isomorphic-git.org/";
    finalUrl = proxy + finalUrl;
  }

  if (['markers','lyrics','text'].includes(k)) markersFile = finalUrl;
  else stems.push({ name: key, url: finalUrl });
}

const ctx = new (window.AudioContext || window.webkitAudioContext)();
const masterGain = ctx.createGain();
masterGain.connect(ctx.destination);

const trackData = [];
let playingNodes = [];
let startAt = 0, pausedAt = 0, playing = false;
let loopActive=false, loopStart=null, loopEnd=null, raf;

// unlock iOS audio
function unlockAudio(){
  const buffer=ctx.createBuffer(1,1,22050);
  const src=ctx.createBufferSource();
  src.buffer=buffer; src.connect(ctx.destination); src.start(0);
  if(ctx.state==='suspended')ctx.resume();
}
document.body.addEventListener('touchstart',unlockAudio,{once:true});
document.body.addEventListener('click',unlockAudio,{once:true});

// LOOP
const loopButton=document.getElementById('loop');
loopButton.addEventListener('click',()=>{
  const current=ctx.currentTime-startAt;
  if(!loopStart&&!loopEnd){loopStart=current;loopButton.textContent='Loop End';}
  else if(loopStart&&!loopEnd){
    loopEnd=current;loopActive=true;
    loopButton.textContent='Clear Loop';loopButton.classList.add('active');renderLoopHighlight();
  }else{
    loopActive=false;loopStart=null;loopEnd=null;
    loopButton.textContent='Loop Start';loopButton.classList.remove('active');clearLoopHighlight();
  }
});

// PROGRESS UI
const progressContainer=document.getElementById('progressContainer');
const progress=document.createElement('input');
progress.type='range';progress.min=0;progress.max=1;progress.step=0.001;
progress.style.width='100%';progress.style.display='block';progress.style.marginTop='1rem';
const loopHighlight=document.createElement('div');loopHighlight.className='loop-highlight';
progressContainer.appendChild(loopHighlight);
const timeRow=document.createElement('div');timeRow.className='time';
const currentTimeEl=document.createElement('span');currentTimeEl.textContent='0:00';
const totalTimeEl=document.createElement('span');totalTimeEl.textContent='0:00';
timeRow.appendChild(currentTimeEl);timeRow.appendChild(totalTimeEl);
progressContainer.appendChild(progress);progressContainer.appendChild(timeRow);

// LOAD STEMS
async function loadStems(){
  const overlay=document.getElementById("loadingOverlay");
  const text=document.getElementById("loadingText");
  let loaded=0,total=stems.length;
  for(const s of stems){
    try{
      const res=await fetch(s.url);
      if(!res.ok)throw new Error(`HTTP ${res.status}`);
      const arr=await res.arrayBuffer();
      const buf=await ctx.decodeAudioData(arr);
      trackData.push({...s,buffer:buf,gain:1,muted:false,solo:false});
      loaded++; text.textContent=`Loading ${loaded} of ${total}...`;
    }catch(e){
      console.error("Error loading",s.url,e);
      loaded++; text.textContent=`Error loading ${s.name}`;
    }
  }
  renderTracks();updateDuration();
  if(markersFile)await loadMarkersFile(markersFile);
  overlay.style.display="none";
}

// MARKERS
async function loadMarkersFile(url){
  try{
    const res=await fetch(url);
    const txt=await res.text();
    const sections=parseMarkers(txt);
    renderBookmarks(sections);
  }catch(e){console.error("Error loading markers",e);}
}
function parseMarkers(txt){
  const r=/(\d+:\d+:\d+\.\d+)\s+Textblock:\s*(.*)/g;const arr=[];let m;
  while((m=r.exec(txt))!==null){const t=toSec(m[1]);const l=m[2].trim();if(l)arr.push({label:l,time:t});}
  return arr;
}
function toSec(ts){const [h,m,s]=ts.split(':').map(parseFloat);return h*3600+m*60+s;}

function renderBookmarks(sections){
  const panel=document.getElementById('bookmarksPanel');
  panel.innerHTML='<h3>Bookmarks</h3>';
  if(!sections.length){panel.innerHTML+='<p>No bookmarks.</p>';return;}
  sections.forEach(sec=>{
    const b=document.createElement('button');
    b.textContent=`${fmt(sec.time)} – ${sec.label}`;
    b.onclick=()=>seekAbsolute(sec.time);
    panel.appendChild(b);
  });
}

// SEEK with lead-in
async function seekAbsolute(sec){
  const t=Math.max(0,sec-(leadInEnabled?5:0));
  pausedAt=t;
  const total=getTotalDuration();
  if(total){progress.value=t/total;currentTimeEl.textContent=fmt(t);}
  if(playing){if(ctx.state==='suspended')await ctx.resume();startPlayback(t);}
  else currentTimeEl.textContent=fmt(t);
}

// CORE PLAYER
function getTotalDuration(){return trackData.reduce((m,t)=>Math.max(m,t.buffer?t.buffer.duration:0),0);}
function renderTracks(){
  const c=document.getElementById('tracks');c.innerHTML='';
  trackData.forEach((t)=>{
    const d=document.createElement('div');d.className='track';
    d.innerHTML=`<strong>${t.name}</strong><br>
      <button data-action="solo">Solo</button>
      <button data-action="mute">Mute</button>
      <label>Vol <input data-action="gain" type="range" min="0" max="2" step="0.01" value="1"></label>`;
    d.querySelectorAll('button,input').forEach(el=>{
      el.addEventListener('click',(e)=>ctrl(e,t));
      el.addEventListener('input',(e)=>ctrl(e,t));
    });
    c.appendChild(d);
  });
  updateButtons();
}
function ctrl(e,track){
  const a=e.target.dataset.action;
  if(a==='gain')track.gain=+e.target.value;
  if(a==='mute')track.muted=!track.muted;
  if(a==='solo')track.solo=!track.solo;
  updateButtons();updateGains();
}
function updateButtons(){
  document.querySelectorAll('.track').forEach((div,i)=>{
    const t=trackData[i];
    div.querySelector('[data-action="solo"]').classList.toggle('active',t.solo);
    div.querySelector('[data-action="mute"]').classList.toggle('active',t.muted);
  });
}
function startPlayback(offset=0){
  const soloed=trackData.some(t=>t.solo);
  stopPlayback();
  trackData.forEach(t=>{
    if(!t.buffer)return;
    const src=ctx.createBufferSource();
    src.buffer=t.buffer;
    const g=ctx.createGain();
    g.gain.value=t.muted||(soloed&&!t.solo)?0:t.gain;
    src.connect(g);g.connect(masterGain);
    src.start(0,offset);
    playingNodes.push({src,g,t});
  });
  startAt=ctx.currentTime-offset;
  playing=true;
  updateProgress();
}
function stopPlayback(){playingNodes.forEach(p=>{try{p.src.stop();}catch{}});
  playingNodes=[];playing=false;cancelAnimationFrame(raf);}
function pausePlayback(){if(!playing)return;pausedAt=ctx.currentTime-startAt;stopPlayback();}
function updateGains(){
  const soloed=trackData.some(t=>t.solo);
  playingNodes.forEach(p=>{
    p.g.gain.value=soloed?(p.t.solo?p.t.gain:0):(p.t.muted?0:p.t.gain);
  });
}
function updateDuration(){totalTimeEl.textContent=fmt(getTotalDuration());}
function renderLoopHighlight(){
  const tot=getTotalDuration();if(!tot||!loopStart||!loopEnd)return;
  const s=loopStart/tot*100,e=loopEnd/tot*100;
  loopHighlight.style.left=`${s}%`;loopHighlight.style.width=`${e-s}%`;loopHighlight.style.display='block';
}
function clearLoopHighlight(){loopHighlight.style.display='none';}
function updateProgress(){
  if(!playing)return;
  const tot=getTotalDuration(),el=ctx.currentTime-startAt;
  const val=Math.min(el/tot,1);progress.value=val;currentTimeEl.textContent=fmt(el);
  if(loopActive&&loopStart!=null&&loopEnd!=null&&el>=loopEnd){startPlayback(loopStart);return;}
  if(val<1)raf=requestAnimationFrame(updateProgress);
}
function fmt(sec){if(!sec||isNaN(sec))return'0:00';
  const m=Math.floor(sec/60),s=Math.floor(sec%60);return`${m}:${s.toString().padStart(2,'0')}`;}

document.getElementById('play').onclick=()=>{if(ctx.state==='suspended')ctx.resume();if(!playing)startPlayback(pausedAt);};
document.getElementById('pause').onclick=pausePlayback;
document.getElementById('stop').onclick=()=>{pausedAt=0;stopPlayback();progress.value=0;currentTimeEl.textContent='0:00';};
document.getElementById('masterVol').oninput=e=>{masterGain.gain.value=e.target.value;};

loadStems();
</script>
</body>
</html>
